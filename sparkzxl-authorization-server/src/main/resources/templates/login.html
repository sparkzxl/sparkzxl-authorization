<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>sparkzxl统一登录平台</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="icon" th:href="@{/images/logo.png}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/admin.css}" media="all">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" media="all">
</head>
<body>
<input type="hidden" id="contextPath" name="contextPath" th:value="${#request.getContextPath()}">
<div class="login-main">
    <div class="layui-card login-card">
        <div class="layui-card-body" style="height: 370px;">
            <div class="login-title">
                sparkzxl统一登录平台
            </div>
            <div class="login-form">
                <form action="/authentication/form" method="post" class="layui-form layui-form-pane">
                    <div class="layui-form-item">
                        <label class="layui-form-label">
                            租户code
                        </label>
                        <div class="layui-input-inline" style="width: 50%;">
                            <input type="text" id="tenantCode" name="tenantCode" class="layui-input"
                                   placeholder="请输入租户code">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">
                            用户名
                        </label>
                        <div class="layui-input-inline" style="width: 50%;">
                            <input type="text" id="username" name="username" class="layui-input" lay-verify="required"
                                   placeholder="请输入用户名">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">
                            密码
                        </label>
                        <div class="layui-input-inline" style="width: 50%;">
                            <input type="password" id="password" name="password" class="layui-input"
                                   lay-verify="required" placeholder="请输入密码">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">
                            验证码
                        </label>
                        <div class="login-form-line" style="width: 50%;">
                            <input type="hidden" id="captchaKey" name="captchaKey">
                            <input type="text" id="captchaCode" name="captchaCode" class="layui-input"
                                   lay-verify="required" placeholder="验证码">
                        </div>
                        <div class="login-form-line-img">
                            <img id="captchaImg" onclick="refreshCaptcha();"/>
                        </div>
                    </div>
                    <div class="login-button">
                        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="login" type="submit">登录
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script th:src="@{/jquery/jquery.min.js}"></script>
<script th:src="@{/layui/layui.js}" charset="utf-8"></script>
<script type="text/javascript" th:src="@{/js/loadingAjax.js}"></script>
<script>
    const contextPath = $("#contextPath").val();
    const url = contextPath + '/oauth/captcha?type=arithmetic';
    var form;
    layui.use('form', function () {
        form = layui.form;
        refreshCaptcha();
        form.on('submit(login)', function (data) {
            // 校验租户信息
            const url = contextPath + '/oauth/checkTenant';
            const param = 'tenantCode=' + data.field.tenantCode;
            const responseData = loadingAjaxJsonData('get', url, param);
            if (responseData.code !== 200) {
                layer.alert('租户不存在，请重新输入！', {icon: 5});
                return false;
            }
            // 校验验证码
            const sendCaptchaUrl = contextPath + '/oauth/checkCaptcha';
            const captchaParam = 'key=' + data.field.captchaKey + '&code=' + data.field.captchaCode;
            const captchaResponseData = loadingAjaxJsonData('get', sendCaptchaUrl, captchaParam);
            if (captchaResponseData.code !== 200) {
                layer.alert(captchaResponseData.msg, {icon: 5});
                refreshCaptcha();
                return false;
            }
            return true;
        });
    });

    function refreshCaptcha() {
        const url = contextPath + '/oauth/captcha';
        const param = 'type=arithmetic';
        const data = loadingAjaxJsonData('get', url, param);
        const captchaData = data.data;
        $("#captchaKey").val(captchaData.key);
        $("#captchaImg").attr("src", captchaData.data);
    }
</script>
</body>
</html>
